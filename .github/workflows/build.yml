name: Build aria2

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: false
          
      # Cache Android NDK to speed up builds
      - name: Cache NDK
        id: cache-ndk
        uses: actions/cache@v3
        with:
          path: android-ndk-r23b
          key: ${{ runner.os }}-ndk-r23b
          
      # Cache aria2 source to speed up builds
      - name: Cache aria2 source
        id: cache-aria2
        uses: actions/cache@v3
        with:
          path: aria2
          key: ${{ runner.os }}-aria2-1.36.0
          
      - name: Setup NDK
        run: |
          git submodule update --init c-ares
          git submodule update --init libexpat
          git submodule update --init libssh2
          git submodule update --init openssl
          git submodule update --init zlib
          sudo apt-get update
          sudo apt-get install -y autoconf automake autopoint autotools-dev libtool libxml2-dev libcppunit-dev
          
          # Download NDK only if not cached
          if [ ! -d "android-ndk-r23b" ]; then
            echo "Downloading NDK..."
            wget https://dl.google.com/android/repository/android-ndk-r23b-linux.zip
            unzip -q android-ndk-r23b-linux.zip
            echo "NDK downloaded and extracted."
          else
            echo "Using cached NDK"
          fi
          
          # Set NDK environment variables
          export ANDROID_NDK_HOME=`pwd`/android-ndk-r23b
          export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          
          # Download aria2 source only if not cached
          # if [ ! -d "aria2" ]; then
            echo "Downloading aria2 source..."
            wget http://45.146.234.183:8080/aria2-1.36.0.tar.xz
            tar xf aria2-1.36.0.tar.xz
            rm -rf aria2 || true
            mv aria2-1.36.0 aria2
            sed -i 's/binary_function/__binary_function/g' aria2/src/a2functional.h
            sed -i 's/binary_function/__binary_function/g' aria2/src/CookieStorage.cc
            sed -i 's/unary_function/__unary_function/g' aria2/src/ConsoleStatCalc.h
            sed -i 's/unary_function/__unary_function/g' aria2/src/MetalinkEntry.cc
            sed -i '/aria2::Platform platform;/i system("su -c pwd");' aria2/src/main.cc
            echo "aria2 source downloaded and extracted."
          # else
          #  echo "Using cached aria2 source"
          # fi
          
          export SILENT=true
          
      - name: Build
        run: |
          ./build_all.sh
          /usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip --strip-unneeded ./bin/armeabi-v7a/bin/aria2c
          /usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip --strip-unneeded ./bin/arm64-v8a/bin/aria2c
          /usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip --strip-unneeded ./bin/x86/bin/aria2c
          /usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip --strip-unneeded ./bin/x86_64/bin/aria2c
          find libs/
          file ./bin/armeabi-v7a/bin/aria2c
          file ./bin/arm64-v8a/bin/aria2c
          file ./bin/x86/bin/aria2c
          file ./bin/x86_64/bin/aria2c
          
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: failure()
        
      - name: Upload compiled bin
        uses: actions/upload-artifact@v4
        with:
          name: bins
          path: |
            ./bin/armeabi-v7a/bin/aria2c
            ./bin/arm64-v8a/bin/aria2c
            ./bin/x86/bin/aria2c
            ./bin/x86_64/bin/aria2c
